let AIClass=(function(){"use strict";const JPGQualityFactor=0.8;const JpgMimeType='image/jpeg';const WatermarkUrl='/images/logos/watermark.png';let WatermarkImage=null;let ShareOverlay=null;function init(){initGlobals();ShareOverlay.on('click',function(){toggleShareOverlay(false);});ShareOverlay.find('.displayBox').on('click',function(e){e.stopPropagation();});ShareOverlay.find('.copy.link').on('click',function(e){let rawShareURL=$(this).closest('.linkBox').find('.link.sharePage').attr('href');ClipboardClass.copyText(rawShareURL);MessageClass.showMessage('Copied link!');});}
function initGlobals(){ShareOverlay=$('#shareOverlay');WatermarkImage=new Image();WatermarkImage.src=WatermarkUrl;}
function addWatermarkToImage(imageUrl,isRepeating){let promise=$.Deferred();let contentImage=new Image();contentImage.onload=function(){let compositeImage=addWatermark(contentImage,isRepeating);promise.resolve(compositeImage);}
contentImage.src=imageUrl;return promise;}
function addWatermark(contentImage,isRepeating){let canvasWidth=contentImage.width;let canvasHeight=contentImage.height;let watermarkCanvas=createWatermarkCanvas(canvasWidth,canvasHeight,isRepeating);let mergedCanvas=document.createElement('canvas');mergedCanvas.width=canvasWidth;mergedCanvas.height=canvasHeight;let context=mergedCanvas.getContext('2d');context.drawImage(contentImage,0,0);context.drawImage(watermarkCanvas,0,0);let mergedImageURL=mergedCanvas.toDataURL();return mergedImageURL;}
function createWatermarkCanvas(canvasWidth,canvasHeight,isRepeating){let canvas=document.createElement('canvas');canvas.width=canvasWidth;canvas.height=canvasHeight;let context=canvas.getContext('2d');if(isRepeating){drawRepeatingWatermark(context,canvasWidth,canvasHeight);}else{drawSmallWatermark(context,canvasWidth,canvasHeight);}
return canvas;}
function getWatermarkSize(canvasWidth,canvasHeight,isRepeating){let minHeight=15;let maxHeight=isRepeating?45:25;let heightRatio=isRepeating?0.08:0.05;let watermarkHeight=canvasHeight*heightRatio;if(watermarkHeight<minHeight){watermarkHeight=minHeight;}else if(watermarkHeight>maxHeight){watermarkHeight=maxHeight;}
let watermarkWidth=watermarkHeight*(WatermarkImage.width/WatermarkImage.height);return{width:watermarkWidth,height:watermarkHeight}}
function drawSmallWatermark(context,canvasWidth,canvasHeight){let watermarkAlpha=0.8;let leftOffset=30;let bottomOffset=20;let watermarkSize=getWatermarkSize(canvasWidth,canvasHeight,false);let watermarkWidth=watermarkSize.width;let watermarkHeight=watermarkSize.height;let x=leftOffset;let y=canvasHeight-watermarkHeight-bottomOffset;let minRatio=3;if(canvasWidth/watermarkWidth<minRatio){x=10;y=canvasHeight-watermarkHeight-10;}
if(canvasHeight/watermarkHeight<minRatio){x=10;y=canvasHeight-watermarkHeight-10;}
let originalAlpha=context.globalAlpha;context.globalAlpha=watermarkAlpha;context.drawImage(WatermarkImage,x,y,watermarkWidth,watermarkHeight);context.globalAlpha=originalAlpha;}
function drawRepeatingWatermark(context,canvasWidth,canvasHeight){let watermarkAlpha=0.2;let watermarkSize=getWatermarkSize(canvasWidth,canvasHeight,true);let watermarkWidth=watermarkSize.width;let watermarkHeight=watermarkSize.height;let repeatingCanvas=document.createElement('canvas');repeatingCanvas.width=watermarkWidth*1.5;repeatingCanvas.height=watermarkHeight*1.5;let repeatingContext=repeatingCanvas.getContext('2d');repeatingContext.globalAlpha=watermarkAlpha;repeatingContext.drawImage(WatermarkImage,0,0,watermarkWidth,watermarkHeight);let pattern=context.createPattern(repeatingCanvas,'repeat');context.fillStyle=pattern;context.fillRect(0,0,canvasWidth,canvasHeight);}
function isValidCode(code){let rejectedCodes=['viktorij','yeppaah8'];let acceptedCodes=['gameupscale','localization5982823','m87smjAzQRm'];if(code&&!rejectedCodes.includes(code)){return code.length===8||code.length===15||acceptedCodes.includes(code);}else{return false;}}
function getPromoCode(){let code=getURLParameter('promo');return code;}
function hasPromoCode(){let code=getPromoCode();if(!isValidCode(code)){return false;}else{return true;}}
function createRequestId(){let requestId=createAlphanumericString(5);return requestId;}
function createXmlHttpRequest(resultBox,responseType){let xhr=new XMLHttpRequest();xhr.onreadystatechange=function(){if(xhr.readyState==2){if(responseType!=='json'){if(xhr.status==200){xhr.responseType='blob';}else{xhr.responseType='text';}}
resultBox.find('.stageBox.processing').addClass('done');resultBox.find('.stageBox.downloading').addClass('active');}};xhr.upload.addEventListener('load',function(uploadEvent){resultBox.find('.stageBox.uploading').addClass('done');resultBox.find('.stageBox.processing').addClass('active');});return xhr;}
async function resizeImage(file,maxSize){let reducer=new ImageBlobReduce();let blob=await reducer.toBlob(file,{max:maxSize,unsharpAmount:80,unsharpRadius:0.6,unsharpThreshold:2});let dataUrl=await blobToDataUrl(blob);let resizedFile=new File([blob],'image');return resizedFile;}
function blobToDataUrl(blob,callback){let promise=$.Deferred();let reader=new FileReader();reader.onload=function(e){promise.resolve(e.target.result);}
reader.readAsDataURL(blob);return promise;}
return{init:init,addWatermarkToImage:addWatermarkToImage,hasPromoCode:hasPromoCode,createRequestId:createRequestId,createXmlHttpRequest:createXmlHttpRequest,resizeImage:resizeImage,};})();