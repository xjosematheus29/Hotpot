/*!image-blob-reduce 2.2.0 https://github.com/nodeca/image-blob-reduce @license MIT*/(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,global.ImageBlobReduce=factory());}(this,(function(){'use strict';var assign=function assign(to){var from;for(var s=1;s<arguments.length;s++){from=Object(arguments[s]);for(var key in from){if(Object.prototype.hasOwnProperty.call(from,key))to[key]=from[key];}}
return to;};function pick(from,props){var to={};props.forEach(function(key){if(Object.prototype.hasOwnProperty.call(from,key))to[key]=from[key];});return to;}
function pick_pica_resize_options(from){return pick(from,['alpha','unsharpAmount','unsharpRadius','unsharpThreshold','cancelToken']);}
var pick_1=pick;var pick_pica_resize_options_1=pick_pica_resize_options;var utils={assign:assign,pick:pick_1,pick_pica_resize_options:pick_pica_resize_options_1};function createCommonjsModule(fn,basedir,module){return module={path:basedir,exports:{},require:function(path,base){return commonjsRequire(path,(base===undefined||base===null)?module.path:base);}},fn(module,module.exports),module.exports;}
function commonjsRequire(){throw new Error('Dynamic requires are not currently supported by @rollup/plugin-commonjs');}
var pica=createCommonjsModule(function(module,exports){/*!
pica
https://github.com/nodeca/pica
*/(function(f){{module.exports=f();}})(function(){return(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof commonjsRequire&&commonjsRequire;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t);}return n[i].exports}for(var u="function"==typeof commonjsRequire&&commonjsRequire,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(_dereq_,module,exports){var inherits=_dereq_('inherits');var Multimath=_dereq_('multimath');var mm_unsharp_mask=_dereq_('multimath/lib/unsharp_mask');var mm_resize=_dereq_('./mm_resize');function MathLib(requested_features){var __requested_features=requested_features||[];var features={js:__requested_features.indexOf('js')>=0,wasm:__requested_features.indexOf('wasm')>=0};Multimath.call(this,features);this.features={js:features.js,wasm:features.wasm&&this.has_wasm()};this.use(mm_unsharp_mask);this.use(mm_resize);}
inherits(MathLib,Multimath);MathLib.prototype.resizeAndUnsharp=function resizeAndUnsharp(options,cache){var result=this.resize(options,cache);if(options.unsharpAmount){this.unsharp_mask(result,options.toWidth,options.toHeight,options.unsharpAmount,options.unsharpRadius,options.unsharpThreshold);}
return result;};module.exports=MathLib;},{"./mm_resize":4,"inherits":15,"multimath":16,"multimath/lib/unsharp_mask":19}],2:[function(_dereq_,module,exports){function clampTo8(i){return i<0?0:i>255?255:i;}
function convolveHorizontally(src,dest,srcW,srcH,destW,filters){var r,g,b,a;var filterPtr,filterShift,filterSize;var srcPtr,srcY,destX,filterVal;var srcOffset=0,destOffset=0;for(srcY=0;srcY<srcH;srcY++){filterPtr=0;for(destX=0;destX<destW;destX++){filterShift=filters[filterPtr++];filterSize=filters[filterPtr++];srcPtr=srcOffset+filterShift*4|0;r=g=b=a=0;for(;filterSize>0;filterSize--){filterVal=filters[filterPtr++];a=a+filterVal*src[srcPtr+3]|0;b=b+filterVal*src[srcPtr+2]|0;g=g+filterVal*src[srcPtr+1]|0;r=r+filterVal*src[srcPtr]|0;srcPtr=srcPtr+4|0;}
dest[destOffset+3]=clampTo8(a+(1<<13)>>14);dest[destOffset+2]=clampTo8(b+(1<<13)>>14);dest[destOffset+1]=clampTo8(g+(1<<13)>>14);dest[destOffset]=clampTo8(r+(1<<13)>>14);destOffset=destOffset+srcH*4|0;}
destOffset=(srcY+1)*4|0;srcOffset=(srcY+1)*srcW*4|0;}}
function convolveVertically(src,dest,srcW,srcH,destW,filters){var r,g,b,a;var filterPtr,filterShift,filterSize;var srcPtr,srcY,destX,filterVal;var srcOffset=0,destOffset=0;for(srcY=0;srcY<srcH;srcY++){filterPtr=0;for(destX=0;destX<destW;destX++){filterShift=filters[filterPtr++];filterSize=filters[filterPtr++];srcPtr=srcOffset+filterShift*4|0;r=g=b=a=0;for(;filterSize>0;filterSize--){filterVal=filters[filterPtr++];a=a+filterVal*src[srcPtr+3]|0;b=b+filterVal*src[srcPtr+2]|0;g=g+filterVal*src[srcPtr+1]|0;r=r+filterVal*src[srcPtr]|0;srcPtr=srcPtr+4|0;}
dest[destOffset+3]=clampTo8(a+(1<<13)>>14);dest[destOffset+2]=clampTo8(b+(1<<13)>>14);dest[destOffset+1]=clampTo8(g+(1<<13)>>14);dest[destOffset]=clampTo8(r+(1<<13)>>14);destOffset=destOffset+srcH*4|0;}
destOffset=(srcY+1)*4|0;srcOffset=(srcY+1)*srcW*4|0;}}
module.exports={convolveHorizontally:convolveHorizontally,convolveVertically:convolveVertically};},{}],3:[function(_dereq_,module,exports){module.exports='AGFzbQEAAAABFAJgBn9/f39/fwBgB39/f39/f38AAg8BA2VudgZtZW1vcnkCAAEDAwIAAQQEAXAAAAcZAghjb252b2x2ZQAACmNvbnZvbHZlSFYAAQkBAArmAwLBAwEQfwJAIANFDQAgBEUNACAFQQRqIRVBACEMQQAhDQNAIA0hDkEAIRFBACEHA0AgB0ECaiESAn8gBSAHQQF0IgdqIgZBAmouAQAiEwRAQQAhCEEAIBNrIRQgFSAHaiEPIAAgDCAGLgEAakECdGohEEEAIQlBACEKQQAhCwNAIBAoAgAiB0EYdiAPLgEAIgZsIAtqIQsgB0H/AXEgBmwgCGohCCAHQRB2Qf8BcSAGbCAKaiEKIAdBCHZB/wFxIAZsIAlqIQkgD0ECaiEPIBBBBGohECAUQQFqIhQNAAsgEiATagwBC0EAIQtBACEKQQAhCUEAIQggEgshByABIA5BAnRqIApBgMAAakEOdSIGQf8BIAZB/wFIG0EQdEGAgPwHcUEAIAZBAEobIAtBgMAAakEOdSIGQf8BIAZB/wFIG0EYdEEAIAZBAEobciAJQYDAAGpBDnUiBkH/ASAGQf8BSBtBCHRBgP4DcUEAIAZBAEobciAIQYDAAGpBDnUiBkH/ASAGQf8BSBtB/wFxQQAgBkEAShtyNgIAIA4gA2ohDiARQQFqIhEgBEcNAAsgDCACaiEMIA1BAWoiDSADRw0ACwsLIQACQEEAIAIgAyAEIAUgABAAIAJBACAEIAUgBiABEAALCw==';},{}],4:[function(_dereq_,module,exports){module.exports={name:'resize',fn:_dereq_('./resize'),wasm_fn:_dereq_('./resize_wasm'),wasm_src:_dereq_('./convolve_wasm_base64')};},{"./convolve_wasm_base64":3,"./resize":5,"./resize_wasm":8}],5:[function(_dereq_,module,exports){var createFilters=_dereq_('./resize_filter_gen');var convolveHorizontally=_dereq_('./convolve').convolveHorizontally;var convolveVertically=_dereq_('./convolve').convolveVertically;function resetAlpha(dst,width,height){var ptr=3,len=width*height*4|0;while(ptr<len){dst[ptr]=0xFF;ptr=ptr+4|0;}}
module.exports=function resize(options){var src=options.src;var srcW=options.width;var srcH=options.height;var destW=options.toWidth;var destH=options.toHeight;var scaleX=options.scaleX||options.toWidth/options.width;var scaleY=options.scaleY||options.toHeight/options.height;var offsetX=options.offsetX||0;var offsetY=options.offsetY||0;var dest=options.dest||new Uint8Array(destW*destH*4);var quality=typeof options.quality==='undefined'?3:options.quality;var alpha=options.alpha||false;var filtersX=createFilters(quality,srcW,destW,scaleX,offsetX),filtersY=createFilters(quality,srcH,destH,scaleY,offsetY);var tmp=new Uint8Array(destW*srcH*4);convolveHorizontally(src,tmp,srcW,srcH,destW,filtersX);convolveVertically(tmp,dest,srcH,destW,destH,filtersY);if(!alpha)resetAlpha(dest,destW,destH);return dest;};},{"./convolve":2,"./resize_filter_gen":6}],6:[function(_dereq_,module,exports){var FILTER_INFO=_dereq_('./resize_filter_info');var FIXED_FRAC_BITS=14;function toFixedPoint(num){return Math.round(num*((1<<FIXED_FRAC_BITS)-1));}
module.exports=function resizeFilterGen(quality,srcSize,destSize,scale,offset){var filterFunction=FILTER_INFO[quality].filter;var scaleInverted=1.0/scale;var scaleClamped=Math.min(1.0,scale);var srcWindow=FILTER_INFO[quality].win/scaleClamped;var destPixel,srcPixel,srcFirst,srcLast,filterElementSize,floatFilter,fxpFilter,total,pxl,idx,floatVal,filterTotal,filterVal;var leftNotEmpty,rightNotEmpty,filterShift,filterSize;var maxFilterElementSize=Math.floor((srcWindow+1)*2);var packedFilter=new Int16Array((maxFilterElementSize+2)*destSize);var packedFilterPtr=0;var slowCopy=!packedFilter.subarray||!packedFilter.set;for(destPixel=0;destPixel<destSize;destPixel++){srcPixel=(destPixel+0.5)*scaleInverted+offset;srcFirst=Math.max(0,Math.floor(srcPixel-srcWindow));srcLast=Math.min(srcSize-1,Math.ceil(srcPixel+srcWindow));filterElementSize=srcLast-srcFirst+1;floatFilter=new Float32Array(filterElementSize);fxpFilter=new Int16Array(filterElementSize);total=0.0;for(pxl=srcFirst,idx=0;pxl<=srcLast;pxl++,idx++){floatVal=filterFunction((pxl+0.5-srcPixel)*scaleClamped);total+=floatVal;floatFilter[idx]=floatVal;}
filterTotal=0;for(idx=0;idx<floatFilter.length;idx++){filterVal=floatFilter[idx]/total;filterTotal+=filterVal;fxpFilter[idx]=toFixedPoint(filterVal);}
fxpFilter[destSize>>1]+=toFixedPoint(1.0-filterTotal);leftNotEmpty=0;while(leftNotEmpty<fxpFilter.length&&fxpFilter[leftNotEmpty]===0){leftNotEmpty++;}
if(leftNotEmpty<fxpFilter.length){rightNotEmpty=fxpFilter.length-1;while(rightNotEmpty>0&&fxpFilter[rightNotEmpty]===0){rightNotEmpty--;}
filterShift=srcFirst+leftNotEmpty;filterSize=rightNotEmpty-leftNotEmpty+1;packedFilter[packedFilterPtr++]=filterShift;packedFilter[packedFilterPtr++]=filterSize;if(!slowCopy){packedFilter.set(fxpFilter.subarray(leftNotEmpty,rightNotEmpty+1),packedFilterPtr);packedFilterPtr+=filterSize;}else{for(idx=leftNotEmpty;idx<=rightNotEmpty;idx++){packedFilter[packedFilterPtr++]=fxpFilter[idx];}}}else{packedFilter[packedFilterPtr++]=0;packedFilter[packedFilterPtr++]=0;}}
return packedFilter;};},{"./resize_filter_info":7}],7:[function(_dereq_,module,exports){module.exports=[{win:0.5,filter:function filter(x){return x>=-0.5&&x<0.5?1.0:0.0;}},{win:1.0,filter:function filter(x){if(x<=-1.0||x>=1.0){return 0.0;}
if(x>-1.19209290E-07&&x<1.19209290E-07){return 1.0;}
var xpi=x*Math.PI;return Math.sin(xpi)/xpi*(0.54+0.46*Math.cos(xpi/1.0));}},{win:2.0,filter:function filter(x){if(x<=-2.0||x>=2.0){return 0.0;}
if(x>-1.19209290E-07&&x<1.19209290E-07){return 1.0;}
var xpi=x*Math.PI;return Math.sin(xpi)/xpi*Math.sin(xpi/2.0)/(xpi/2.0);}},{win:3.0,filter:function filter(x){if(x<=-3.0||x>=3.0){return 0.0;}
if(x>-1.19209290E-07&&x<1.19209290E-07){return 1.0;}
var xpi=x*Math.PI;return Math.sin(xpi)/xpi*Math.sin(xpi/3.0)/(xpi/3.0);}}];},{}],8:[function(_dereq_,module,exports){var createFilters=_dereq_('./resize_filter_gen');function resetAlpha(dst,width,height){var ptr=3,len=width*height*4|0;while(ptr<len){dst[ptr]=0xFF;ptr=ptr+4|0;}}
function asUint8Array(src){return new Uint8Array(src.buffer,0,src.byteLength);}
var IS_LE=true;try{IS_LE=new Uint32Array(new Uint8Array([1,0,0,0]).buffer)[0]===1;}catch(__){}
function copyInt16asLE(src,target,target_offset){if(IS_LE){target.set(asUint8Array(src),target_offset);return;}
for(var ptr=target_offset,i=0;i<src.length;i++){var data=src[i];target[ptr++]=data&0xFF;target[ptr++]=data>>8&0xFF;}}
module.exports=function resize_wasm(options){var src=options.src;var srcW=options.width;var srcH=options.height;var destW=options.toWidth;var destH=options.toHeight;var scaleX=options.scaleX||options.toWidth/options.width;var scaleY=options.scaleY||options.toHeight/options.height;var offsetX=options.offsetX||0.0;var offsetY=options.offsetY||0.0;var dest=options.dest||new Uint8Array(destW*destH*4);var quality=typeof options.quality==='undefined'?3:options.quality;var alpha=options.alpha||false;var filtersX=createFilters(quality,srcW,destW,scaleX,offsetX),filtersY=createFilters(quality,srcH,destH,scaleY,offsetY);var src_offset=0;var tmp_offset=this.__align(src_offset+Math.max(src.byteLength,dest.byteLength));var filtersX_offset=this.__align(tmp_offset+srcH*destW*4);var filtersY_offset=this.__align(filtersX_offset+filtersX.byteLength);var alloc_bytes=filtersY_offset+filtersY.byteLength;var instance=this.__instance('resize',alloc_bytes);var mem=new Uint8Array(this.__memory.buffer);var mem32=new Uint32Array(this.__memory.buffer);var src32=new Uint32Array(src.buffer);mem32.set(src32);copyInt16asLE(filtersX,mem,filtersX_offset);copyInt16asLE(filtersY,mem,filtersY_offset);var fn=instance.exports.convolveHV||instance.exports._convolveHV;fn(filtersX_offset,filtersY_offset,tmp_offset,srcW,srcH,destW,destH);var dest32=new Uint32Array(dest.buffer);dest32.set(new Uint32Array(this.__memory.buffer,0,destH*destW));if(!alpha)resetAlpha(dest,destW,destH);return dest;};},{"./resize_filter_gen":6}],9:[function(_dereq_,module,exports){var GC_INTERVAL=100;function Pool(create,idle){this.create=create;this.available=[];this.acquired={};this.lastId=1;this.timeoutId=0;this.idle=idle||2000;}
Pool.prototype.acquire=function(){var _this=this;var resource;if(this.available.length!==0){resource=this.available.pop();}else{resource=this.create();resource.id=this.lastId++;resource.release=function(){return _this.release(resource);};}
this.acquired[resource.id]=resource;return resource;};Pool.prototype.release=function(resource){var _this2=this;delete this.acquired[resource.id];resource.lastUsed=Date.now();this.available.push(resource);if(this.timeoutId===0){this.timeoutId=setTimeout(function(){return _this2.gc();},GC_INTERVAL);}};Pool.prototype.gc=function(){var _this3=this;var now=Date.now();this.available=this.available.filter(function(resource){if(now-resource.lastUsed>_this3.idle){resource.destroy();return false;}
return true;});if(this.available.length!==0){this.timeoutId=setTimeout(function(){return _this3.gc();},GC_INTERVAL);}else{this.timeoutId=0;}};module.exports=Pool;},{}],10:[function(_dereq_,module,exports){var MIN_INNER_TILE_SIZE=2;module.exports=function createStages(fromWidth,fromHeight,toWidth,toHeight,srcTileSize,destTileBorder){var scaleX=toWidth/fromWidth;var scaleY=toHeight/fromHeight;var minScale=(2*destTileBorder+MIN_INNER_TILE_SIZE+1)/srcTileSize;if(minScale>0.5)return[[toWidth,toHeight]];var stageCount=Math.ceil(Math.log(Math.min(scaleX,scaleY))/Math.log(minScale));if(stageCount<=1)return[[toWidth,toHeight]];var result=[];for(var i=0;i<stageCount;i++){var width=Math.round(Math.pow(Math.pow(fromWidth,stageCount-i-1)*Math.pow(toWidth,i+1),1/stageCount));var height=Math.round(Math.pow(Math.pow(fromHeight,stageCount-i-1)*Math.pow(toHeight,i+1),1/stageCount));result.push([width,height]);}
return result;};},{}],11:[function(_dereq_,module,exports){var PIXEL_EPSILON=1e-5;function pixelFloor(x){var nearest=Math.round(x);if(Math.abs(x-nearest)<PIXEL_EPSILON){return nearest;}
return Math.floor(x);}
function pixelCeil(x){var nearest=Math.round(x);if(Math.abs(x-nearest)<PIXEL_EPSILON){return nearest;}
return Math.ceil(x);}
module.exports=function createRegions(options){var scaleX=options.toWidth/options.width;var scaleY=options.toHeight/options.height;var innerTileWidth=pixelFloor(options.srcTileSize*scaleX)-2*options.destTileBorder;var innerTileHeight=pixelFloor(options.srcTileSize*scaleY)-2*options.destTileBorder;if(innerTileWidth<1||innerTileHeight<1){throw new Error('Internal error in pica: target tile width/height is too small.');}
var x,y;var innerX,innerY,toTileWidth,toTileHeight;var tiles=[];var tile;for(innerY=0;innerY<options.toHeight;innerY+=innerTileHeight){for(innerX=0;innerX<options.toWidth;innerX+=innerTileWidth){x=innerX-options.destTileBorder;if(x<0){x=0;}
toTileWidth=innerX+innerTileWidth+options.destTileBorder-x;if(x+toTileWidth>=options.toWidth){toTileWidth=options.toWidth-x;}
y=innerY-options.destTileBorder;if(y<0){y=0;}
toTileHeight=innerY+innerTileHeight+options.destTileBorder-y;if(y+toTileHeight>=options.toHeight){toTileHeight=options.toHeight-y;}
tile={toX:x,toY:y,toWidth:toTileWidth,toHeight:toTileHeight,toInnerX:innerX,toInnerY:innerY,toInnerWidth:innerTileWidth,toInnerHeight:innerTileHeight,offsetX:x/scaleX-pixelFloor(x/scaleX),offsetY:y/scaleY-pixelFloor(y/scaleY),scaleX:scaleX,scaleY:scaleY,x:pixelFloor(x/scaleX),y:pixelFloor(y/scaleY),width:pixelCeil(toTileWidth/scaleX),height:pixelCeil(toTileHeight/scaleY)};tiles.push(tile);}}
return tiles;};},{}],12:[function(_dereq_,module,exports){function objClass(obj){return Object.prototype.toString.call(obj);}
module.exports.isCanvas=function isCanvas(element){var cname=objClass(element);return cname==='[object HTMLCanvasElement]'||cname==='[object OffscreenCanvas]'||cname==='[object Canvas]';};module.exports.isImage=function isImage(element){return objClass(element)==='[object HTMLImageElement]';};module.exports.isImageBitmap=function isImageBitmap(element){return objClass(element)==='[object ImageBitmap]';};module.exports.limiter=function limiter(concurrency){var active=0,queue=[];function roll(){if(active<concurrency&&queue.length){active++;queue.shift()();}}
return function limit(fn){return new Promise(function(resolve,reject){queue.push(function(){fn().then(function(result){resolve(result);active--;roll();},function(err){reject(err);active--;roll();});});roll();});};};module.exports.cib_quality_name=function cib_quality_name(num){switch(num){case 0:return 'pixelated';case 1:return 'low';case 2:return 'medium';}
return 'high';};module.exports.cib_support=function cib_support(createCanvas){return Promise.resolve().then(function(){if(typeof createImageBitmap==='undefined'){return false;}
var c=createCanvas(100,100);return createImageBitmap(c,0,0,100,100,{resizeWidth:10,resizeHeight:10,resizeQuality:'high'}).then(function(bitmap){var status=bitmap.width===10;bitmap.close();c=null;return status;});})["catch"](function(){return false;});};},{}],13:[function(_dereq_,module,exports){module.exports=function(){var MathLib=_dereq_('./mathlib');var mathLib;onmessage=function onmessage(ev){var opts=ev.data.opts;if(!mathLib)mathLib=new MathLib(ev.data.features);var result=mathLib.resizeAndUnsharp(opts);postMessage({result:result},[result.buffer]);};};},{"./mathlib":1}],14:[function(_dereq_,module,exports){var a0,a1,a2,a3,b1,b2,left_corner,right_corner;function gaussCoef(sigma){if(sigma<0.5){sigma=0.5;}
var a=Math.exp(0.726*0.726)/sigma,g1=Math.exp(-a),g2=Math.exp(-2*a),k=(1-g1)*(1-g1)/(1+2*a*g1-g2);a0=k;a1=k*(a-1)*g1;a2=k*(a+1)*g1;a3=-k*g2;b1=2*g1;b2=-g2;left_corner=(a0+a1)/(1-b1-b2);right_corner=(a2+a3)/(1-b1-b2);return new Float32Array([a0,a1,a2,a3,b1,b2,left_corner,right_corner]);}
function convolveMono16(src,out,line,coeff,width,height){var prev_src,curr_src,curr_out,prev_out,prev_prev_out;var src_index,out_index,line_index;var i,j;var coeff_a0,coeff_a1,coeff_b1,coeff_b2;for(i=0;i<height;i++){src_index=i*width;out_index=i;line_index=0;prev_src=src[src_index];prev_prev_out=prev_src*coeff[6];prev_out=prev_prev_out;coeff_a0=coeff[0];coeff_a1=coeff[1];coeff_b1=coeff[4];coeff_b2=coeff[5];for(j=0;j<width;j++){curr_src=src[src_index];curr_out=curr_src*coeff_a0+
prev_src*coeff_a1+
prev_out*coeff_b1+
prev_prev_out*coeff_b2;prev_prev_out=prev_out;prev_out=curr_out;prev_src=curr_src;line[line_index]=prev_out;line_index++;src_index++;}
src_index--;line_index--;out_index+=height*(width-1);prev_src=src[src_index];prev_prev_out=prev_src*coeff[7];prev_out=prev_prev_out;curr_src=prev_src;coeff_a0=coeff[2];coeff_a1=coeff[3];for(j=width-1;j>=0;j--){curr_out=curr_src*coeff_a0+
prev_src*coeff_a1+
prev_out*coeff_b1+
prev_prev_out*coeff_b2;prev_prev_out=prev_out;prev_out=curr_out;prev_src=curr_src;curr_src=src[src_index];out[out_index]=line[line_index]+prev_out;src_index--;line_index--;out_index-=height;}}}
function blurMono16(src,width,height,radius){if(!radius){return;}
var out=new Uint16Array(src.length),tmp_line=new Float32Array(Math.max(width,height));var coeff=gaussCoef(radius);convolveMono16(src,out,tmp_line,coeff,width,height);convolveMono16(out,src,tmp_line,coeff,height,width);}
module.exports=blurMono16;},{}],15:[function(_dereq_,module,exports){if(typeof Object.create==='function'){module.exports=function inherits(ctor,superCtor){if(superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}});}};}else{module.exports=function inherits(ctor,superCtor){if(superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor();ctor.prototype.constructor=ctor;}};}},{}],16:[function(_dereq_,module,exports){var assign=_dereq_('object-assign');var base64decode=_dereq_('./lib/base64decode');var hasWebAssembly=_dereq_('./lib/wa_detect');var DEFAULT_OPTIONS={js:true,wasm:true};function MultiMath(options){if(!(this instanceof MultiMath))return new MultiMath(options);var opts=assign({},DEFAULT_OPTIONS,options||{});this.options=opts;this.__cache={};this.__init_promise=null;this.__modules=opts.modules||{};this.__memory=null;this.__wasm={};this.__isLE=((new Uint32Array((new Uint8Array([1,0,0,0])).buffer))[0]===1);if(!this.options.js&&!this.options.wasm){throw new Error('mathlib: at least "js" or "wasm" should be enabled');}}
MultiMath.prototype.has_wasm=hasWebAssembly;MultiMath.prototype.use=function(module){this.__modules[module.name]=module;if(this.options.wasm&&this.has_wasm()&&module.wasm_fn){this[module.name]=module.wasm_fn;}else{this[module.name]=module.fn;}
return this;};MultiMath.prototype.init=function(){if(this.__init_promise)return this.__init_promise;if(!this.options.js&&this.options.wasm&&!this.has_wasm()){return Promise.reject(new Error('mathlib: only "wasm" was enabled, but it\'s not supported'));}
var self=this;this.__init_promise=Promise.all(Object.keys(self.__modules).map(function(name){var module=self.__modules[name];if(!self.options.wasm||!self.has_wasm()||!module.wasm_fn)return null;if(self.__wasm[name])return null;return WebAssembly.compile(self.__base64decode(module.wasm_src)).then(function(m){self.__wasm[name]=m;});})).then(function(){return self;});return this.__init_promise;};MultiMath.prototype.__base64decode=base64decode;MultiMath.prototype.__reallocate=function mem_grow_to(bytes){if(!this.__memory){this.__memory=new WebAssembly.Memory({initial:Math.ceil(bytes/(64*1024))});return this.__memory;}
var mem_size=this.__memory.buffer.byteLength;if(mem_size<bytes){this.__memory.grow(Math.ceil((bytes-mem_size)/(64*1024)));}
return this.__memory;};MultiMath.prototype.__instance=function instance(name,memsize,env_extra){if(memsize)this.__reallocate(memsize);if(!this.__wasm[name]){var module=this.__modules[name];this.__wasm[name]=new WebAssembly.Module(this.__base64decode(module.wasm_src));}
if(!this.__cache[name]){var env_base={memoryBase:0,memory:this.__memory,tableBase:0,table:new WebAssembly.Table({initial:0,element:'anyfunc'})};this.__cache[name]=new WebAssembly.Instance(this.__wasm[name],{env:assign(env_base,env_extra||{})});}
return this.__cache[name];};MultiMath.prototype.__align=function align(number,base){base=base||8;var reminder=number%base;return number+(reminder?base-reminder:0);};module.exports=MultiMath;},{"./lib/base64decode":17,"./lib/wa_detect":23,"object-assign":24}],17:[function(_dereq_,module,exports){var BASE64_MAP='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';module.exports=function base64decode(str){var input=str.replace(/[\r\n=]/g,''),max=input.length;var out=new Uint8Array((max*3)>>2);var bits=0;var ptr=0;for(var idx=0;idx<max;idx++){if((idx%4===0)&&idx){out[ptr++]=(bits>>16)&0xFF;out[ptr++]=(bits>>8)&0xFF;out[ptr++]=bits&0xFF;}
bits=(bits<<6)|BASE64_MAP.indexOf(input.charAt(idx));}
var tailbits=(max%4)*6;if(tailbits===0){out[ptr++]=(bits>>16)&0xFF;out[ptr++]=(bits>>8)&0xFF;out[ptr++]=bits&0xFF;}else if(tailbits===18){out[ptr++]=(bits>>10)&0xFF;out[ptr++]=(bits>>2)&0xFF;}else if(tailbits===12){out[ptr++]=(bits>>4)&0xFF;}
return out;};},{}],18:[function(_dereq_,module,exports){module.exports=function hsl_l16_js(img,width,height){var size=width*height;var out=new Uint16Array(size);var r,g,b,min,max;for(var i=0;i<size;i++){r=img[4*i];g=img[4*i+1];b=img[4*i+2];max=(r>=g&&r>=b)?r:(g>=b&&g>=r)?g:b;min=(r<=g&&r<=b)?r:(g<=b&&g<=r)?g:b;out[i]=(max+min)*257>>1;}
return out;};},{}],19:[function(_dereq_,module,exports){module.exports={name:'unsharp_mask',fn:_dereq_('./unsharp_mask'),wasm_fn:_dereq_('./unsharp_mask_wasm'),wasm_src:_dereq_('./unsharp_mask_wasm_base64')};},{"./unsharp_mask":20,"./unsharp_mask_wasm":21,"./unsharp_mask_wasm_base64":22}],20:[function(_dereq_,module,exports){var glur_mono16=_dereq_('glur/mono16');var hsl_l16=_dereq_('./hsl_l16');module.exports=function unsharp(img,width,height,amount,radius,threshold){var r,g,b;var h,s,l;var min,max;var m1,m2,hShifted;var diff,iTimes4;if(amount===0||radius<0.5){return;}
if(radius>2.0){radius=2.0;}
var lightness=hsl_l16(img,width,height);var blured=new Uint16Array(lightness);glur_mono16(blured,width,height,radius);var amountFp=(amount/100*0x1000+0.5)|0;var thresholdFp=(threshold*257)|0;var size=width*height;for(var i=0;i<size;i++){diff=2*(lightness[i]-blured[i]);if(Math.abs(diff)>=thresholdFp){iTimes4=i*4;r=img[iTimes4];g=img[iTimes4+1];b=img[iTimes4+2];max=(r>=g&&r>=b)?r:(g>=r&&g>=b)?g:b;min=(r<=g&&r<=b)?r:(g<=r&&g<=b)?g:b;l=(max+min)*257>>1;if(min===max){h=s=0;}else{s=(l<=0x7fff)?(((max-min)*0xfff)/(max+min))|0:(((max-min)*0xfff)/(2*0xff-max-min))|0;h=(r===max)?(((g-b)*0xffff)/(6*(max-min)))|0:(g===max)?0x5555+((((b-r)*0xffff)/(6*(max-min)))|0):0xaaaa+((((r-g)*0xffff)/(6*(max-min)))|0);}
l+=(amountFp*diff+0x800)>>12;if(l>0xffff){l=0xffff;}else if(l<0){l=0;}
if(s===0){r=g=b=l>>8;}else{m2=(l<=0x7fff)?(l*(0x1000+s)+0x800)>>12:l+(((0xffff-l)*s+0x800)>>12);m1=2*l-m2>>8;m2>>=8;hShifted=(h+0x5555)&0xffff;r=(hShifted>=0xaaaa)?m1:(hShifted>=0x7fff)?m1+((m2-m1)*6*(0xaaaa-hShifted)+0x8000>>16):(hShifted>=0x2aaa)?m2:m1+((m2-m1)*6*hShifted+0x8000>>16);hShifted=h&0xffff;g=(hShifted>=0xaaaa)?m1:(hShifted>=0x7fff)?m1+((m2-m1)*6*(0xaaaa-hShifted)+0x8000>>16):(hShifted>=0x2aaa)?m2:m1+((m2-m1)*6*hShifted+0x8000>>16);hShifted=(h-0x5555)&0xffff;b=(hShifted>=0xaaaa)?m1:(hShifted>=0x7fff)?m1+((m2-m1)*6*(0xaaaa-hShifted)+0x8000>>16):(hShifted>=0x2aaa)?m2:m1+((m2-m1)*6*hShifted+0x8000>>16);}
img[iTimes4]=r;img[iTimes4+1]=g;img[iTimes4+2]=b;}}};},{"./hsl_l16":18,"glur/mono16":14}],21:[function(_dereq_,module,exports){module.exports=function unsharp(img,width,height,amount,radius,threshold){if(amount===0||radius<0.5){return;}
if(radius>2.0){radius=2.0;}
var pixels=width*height;var img_bytes_cnt=pixels*4;var hsl_bytes_cnt=pixels*2;var blur_bytes_cnt=pixels*2;var blur_line_byte_cnt=Math.max(width,height)*4;var blur_coeffs_byte_cnt=8*4;var img_offset=0;var hsl_offset=img_bytes_cnt;var blur_offset=hsl_offset+hsl_bytes_cnt;var blur_tmp_offset=blur_offset+blur_bytes_cnt;var blur_line_offset=blur_tmp_offset+blur_bytes_cnt;var blur_coeffs_offset=blur_line_offset+blur_line_byte_cnt;var instance=this.__instance('unsharp_mask',img_bytes_cnt+hsl_bytes_cnt+blur_bytes_cnt*2+blur_line_byte_cnt+blur_coeffs_byte_cnt,{exp:Math.exp});var img32=new Uint32Array(img.buffer);var mem32=new Uint32Array(this.__memory.buffer);mem32.set(img32);var fn=instance.exports.hsl_l16||instance.exports._hsl_l16;fn(img_offset,hsl_offset,width,height);fn=instance.exports.blurMono16||instance.exports._blurMono16;fn(hsl_offset,blur_offset,blur_tmp_offset,blur_line_offset,blur_coeffs_offset,width,height,radius);fn=instance.exports.unsharp||instance.exports._unsharp;fn(img_offset,img_offset,hsl_offset,blur_offset,width,height,amount,threshold);img32.set(new Uint32Array(this.__memory.buffer,0,pixels));};},{}],22:[function(_dereq_,module,exports){module.exports='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';},{}],23:[function(_dereq_,module,exports){var wa;module.exports=function hasWebAssembly(){if(typeof wa!=='undefined')return wa;wa=false;if(typeof WebAssembly==='undefined')return wa;try{var bin=new Uint8Array([0,97,115,109,1,0,0,0,1,6,1,96,1,127,1,127,3,2,1,0,5,3,1,0,1,7,8,1,4,116,101,115,116,0,0,10,16,1,14,0,32,0,65,1,54,2,0,32,0,40,2,0,11]);var module=new WebAssembly.Module(bin);var instance=new WebAssembly.Instance(module,{});if(instance.exports.test(4)!==0)wa=true;return wa;}catch(__){}
return wa;};},{}],24:[function(_dereq_,module,exports){var getOwnPropertySymbols=Object.getOwnPropertySymbols;var hasOwnProperty=Object.prototype.hasOwnProperty;var propIsEnumerable=Object.prototype.propertyIsEnumerable;function toObject(val){if(val===null||val===undefined){throw new TypeError('Object.assign cannot be called with null or undefined');}
return Object(val);}
function shouldUseNative(){try{if(!Object.assign){return false;}
var test1=new String('abc');test1[5]='de';if(Object.getOwnPropertyNames(test1)[0]==='5'){return false;}
var test2={};for(var i=0;i<10;i++){test2['_'+String.fromCharCode(i)]=i;}
var order2=Object.getOwnPropertyNames(test2).map(function(n){return test2[n];});if(order2.join('')!=='0123456789'){return false;}
var test3={};'abcdefghijklmnopqrst'.split('').forEach(function(letter){test3[letter]=letter;});if(Object.keys(Object.assign({},test3)).join('')!=='abcdefghijklmnopqrst'){return false;}
return true;}catch(err){return false;}}
module.exports=shouldUseNative()?Object.assign:function(target,source){var from;var to=toObject(target);var symbols;for(var s=1;s<arguments.length;s++){from=Object(arguments[s]);for(var key in from){if(hasOwnProperty.call(from,key)){to[key]=from[key];}}
if(getOwnPropertySymbols){symbols=getOwnPropertySymbols(from);for(var i=0;i<symbols.length;i++){if(propIsEnumerable.call(from,symbols[i])){to[symbols[i]]=from[symbols[i]];}}}}
return to;};},{}],25:[function(_dereq_,module,exports){var bundleFn=arguments[3];var sources=arguments[4];var cache=arguments[5];var stringify=JSON.stringify;module.exports=function(fn,options){var wkey;var cacheKeys=Object.keys(cache);for(var i=0,l=cacheKeys.length;i<l;i++){var key=cacheKeys[i];var exp=cache[key].exports;if(exp===fn||exp&&exp.default===fn){wkey=key;break;}}
if(!wkey){wkey=Math.floor(Math.pow(16,8)*Math.random()).toString(16);var wcache={};for(var i=0,l=cacheKeys.length;i<l;i++){var key=cacheKeys[i];wcache[key]=key;}
sources[wkey]=['function(require,module,exports){'+fn+'(self); }',wcache];}
var skey=Math.floor(Math.pow(16,8)*Math.random()).toString(16);var scache={};scache[wkey]=wkey;sources[skey]=['function(require,module,exports){'+
'var f = require('+stringify(wkey)+');'+
'(f.default ? f.default : f)(self);'+
'}',scache];var workerSources={};resolveSources(skey);function resolveSources(key){workerSources[key]=true;for(var depPath in sources[key][1]){var depKey=sources[key][1][depPath];if(!workerSources[depKey]){resolveSources(depKey);}}}
var src='('+bundleFn+')({'
+Object.keys(workerSources).map(function(key){return stringify(key)+':['
+sources[key][0]
+','+stringify(sources[key][1])+']';}).join(',')
+'},{},['+stringify(skey)+'])';var URL=window.URL||window.webkitURL||window.mozURL||window.msURL;var blob=new Blob([src],{type:'text/javascript'});if(options&&options.bare){return blob;}
var workerUrl=URL.createObjectURL(blob);var worker=new Worker(workerUrl);worker.objectURL=workerUrl;return worker;};},{}],"/index.js":[function(_dereq_,module,exports){function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest();}
function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}
function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}
function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}
function _iterableToArrayLimit(arr,i){if(typeof Symbol==="undefined"||!(Symbol.iterator in Object(arr)))return;var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"]!=null)_i["return"]();}finally{if(_d)throw _e;}}return _arr;}
function _arrayWithHoles(arr){if(Array.isArray(arr))return arr;}
var assign=_dereq_('object-assign');var webworkify=_dereq_('webworkify');var MathLib=_dereq_('./lib/mathlib');var Pool=_dereq_('./lib/pool');var utils=_dereq_('./lib/utils');var worker=_dereq_('./lib/worker');var createStages=_dereq_('./lib/stepper');var createRegions=_dereq_('./lib/tiler');var singletones={};var NEED_SAFARI_FIX=false;try{if(typeof navigator!=='undefined'&&navigator.userAgent){NEED_SAFARI_FIX=navigator.userAgent.indexOf('Safari')>=0;}}catch(e){}
var concurrency=1;if(typeof navigator!=='undefined'){concurrency=Math.min(navigator.hardwareConcurrency||1,4);}
var DEFAULT_PICA_OPTS={tile:1024,concurrency:concurrency,features:['js','wasm','ww'],idle:2000,createCanvas:function createCanvas(width,height){var tmpCanvas=document.createElement('canvas');tmpCanvas.width=width;tmpCanvas.height=height;return tmpCanvas;}};var DEFAULT_RESIZE_OPTS={quality:3,alpha:false,unsharpAmount:0,unsharpRadius:0.0,unsharpThreshold:0};var CAN_NEW_IMAGE_DATA;var CAN_CREATE_IMAGE_BITMAP;function workerFabric(){return{value:webworkify(worker),destroy:function destroy(){this.value.terminate();if(typeof window!=='undefined'){var url=window.URL||window.webkitURL||window.mozURL||window.msURL;if(url&&url.revokeObjectURL&&this.value.objectURL){url.revokeObjectURL(this.value.objectURL);}}}};}
function Pica(options){if(!(this instanceof Pica))return new Pica(options);this.options=assign({},DEFAULT_PICA_OPTS,options||{});var limiter_key="lk_".concat(this.options.concurrency);this.__limit=singletones[limiter_key]||utils.limiter(this.options.concurrency);if(!singletones[limiter_key])singletones[limiter_key]=this.__limit;this.features={js:false,wasm:false,cib:false,ww:false};this.__workersPool=null;this.__requested_features=[];this.__mathlib=null;}
Pica.prototype.init=function(){var _this=this;if(this.__initPromise)return this.__initPromise;if(CAN_NEW_IMAGE_DATA!==false&&CAN_NEW_IMAGE_DATA!==true){CAN_NEW_IMAGE_DATA=false;if(typeof ImageData!=='undefined'&&typeof Uint8ClampedArray!=='undefined'){try{new ImageData(new Uint8ClampedArray(400),10,10);CAN_NEW_IMAGE_DATA=true;}catch(__){}}}
if(CAN_CREATE_IMAGE_BITMAP!==false&&CAN_CREATE_IMAGE_BITMAP!==true){CAN_CREATE_IMAGE_BITMAP=false;if(typeof ImageBitmap!=='undefined'){if(ImageBitmap.prototype&&ImageBitmap.prototype.close){CAN_CREATE_IMAGE_BITMAP=true;}else{this.debug('ImageBitmap does not support .close(), disabled');}}}
var features=this.options.features.slice();if(features.indexOf('all')>=0){features=['cib','wasm','js','ww'];}
this.__requested_features=features;this.__mathlib=new MathLib(features);if(features.indexOf('ww')>=0){if(typeof window!=='undefined'&&'Worker'in window){try{var wkr=_dereq_('webworkify')(function(){});wkr.terminate();this.features.ww=true;var wpool_key="wp_".concat(JSON.stringify(this.options));if(singletones[wpool_key]){this.__workersPool=singletones[wpool_key];}else{this.__workersPool=new Pool(workerFabric,this.options.idle);singletones[wpool_key]=this.__workersPool;}}catch(__){}}}
var initMath=this.__mathlib.init().then(function(mathlib){assign(_this.features,mathlib.features);});var checkCibResize;if(!CAN_CREATE_IMAGE_BITMAP){checkCibResize=Promise.resolve(false);}else{checkCibResize=utils.cib_support(this.options.createCanvas).then(function(status){if(_this.features.cib&&features.indexOf('cib')<0){_this.debug('createImageBitmap() resize supported, but disabled by config');return;}
if(features.indexOf('cib')>=0)_this.features.cib=status;});}
this.__initPromise=Promise.all([initMath,checkCibResize]).then(function(){return _this;});return this.__initPromise;};Pica.prototype.resize=function(from,to,options){var _this2=this;this.debug('Start resize...');var opts=assign({},DEFAULT_RESIZE_OPTS);if(!isNaN(options)){opts=assign(opts,{quality:options});}else if(options){opts=assign(opts,options);}
opts.toWidth=to.width;opts.toHeight=to.height;opts.width=from.naturalWidth||from.width;opts.height=from.naturalHeight||from.height;if(to.width===0||to.height===0){return Promise.reject(new Error("Invalid output size: ".concat(to.width,"x").concat(to.height)));}
if(opts.unsharpRadius>2)opts.unsharpRadius=2;var canceled=false;var cancelToken=null;if(opts.cancelToken){cancelToken=opts.cancelToken.then(function(data){canceled=true;throw data;},function(err){canceled=true;throw err;});}
var DEST_TILE_BORDER=3;var destTileBorder=Math.ceil(Math.max(DEST_TILE_BORDER,2.5*opts.unsharpRadius|0));return this.init().then(function(){if(canceled)return cancelToken;if(_this2.features.cib){var toCtx=to.getContext('2d',{alpha:Boolean(opts.alpha)});_this2.debug('Resize via createImageBitmap()');return createImageBitmap(from,{resizeWidth:opts.toWidth,resizeHeight:opts.toHeight,resizeQuality:utils.cib_quality_name(opts.quality)}).then(function(imageBitmap){if(canceled)return cancelToken;if(!opts.unsharpAmount){toCtx.drawImage(imageBitmap,0,0);imageBitmap.close();toCtx=null;_this2.debug('Finished!');return to;}
_this2.debug('Unsharp result');var tmpCanvas=_this2.options.createCanvas(opts.toWidth,opts.toHeight);var tmpCtx=tmpCanvas.getContext('2d',{alpha:Boolean(opts.alpha)});tmpCtx.drawImage(imageBitmap,0,0);imageBitmap.close();var iData=tmpCtx.getImageData(0,0,opts.toWidth,opts.toHeight);_this2.__mathlib.unsharp_mask(iData.data,opts.toWidth,opts.toHeight,opts.unsharpAmount,opts.unsharpRadius,opts.unsharpThreshold);toCtx.putImageData(iData,0,0);tmpCanvas.width=tmpCanvas.height=0;iData=tmpCtx=tmpCanvas=toCtx=null;_this2.debug('Finished!');return to;});}
var cache={};var invokeResize=function invokeResize(opts){return Promise.resolve().then(function(){if(!_this2.features.ww)return _this2.__mathlib.resizeAndUnsharp(opts,cache);return new Promise(function(resolve,reject){var w=_this2.__workersPool.acquire();if(cancelToken)cancelToken["catch"](function(err){return reject(err);});w.value.onmessage=function(ev){w.release();if(ev.data.err)reject(ev.data.err);else resolve(ev.data.result);};w.value.postMessage({opts:opts,features:_this2.__requested_features,preload:{wasm_nodule:_this2.__mathlib.__}},[opts.src.buffer]);});});};var tileAndResize=function tileAndResize(from,to,opts){var srcCtx;var srcImageBitmap;var isImageBitmapReused=false;var toCtx;var processTile=function processTile(tile){return _this2.__limit(function(){if(canceled)return cancelToken;var srcImageData;if(utils.isCanvas(from)){_this2.debug('Get tile pixel data');srcImageData=srcCtx.getImageData(tile.x,tile.y,tile.width,tile.height);}else{_this2.debug('Draw tile imageBitmap/image to temporary canvas');var tmpCanvas=_this2.options.createCanvas(tile.width,tile.height);var tmpCtx=tmpCanvas.getContext('2d',{alpha:Boolean(opts.alpha)});tmpCtx.globalCompositeOperation='copy';tmpCtx.drawImage(srcImageBitmap||from,tile.x,tile.y,tile.width,tile.height,0,0,tile.width,tile.height);_this2.debug('Get tile pixel data');srcImageData=tmpCtx.getImageData(0,0,tile.width,tile.height);tmpCanvas.width=tmpCanvas.height=0;tmpCtx=tmpCanvas=null;}
var o={src:srcImageData.data,width:tile.width,height:tile.height,toWidth:tile.toWidth,toHeight:tile.toHeight,scaleX:tile.scaleX,scaleY:tile.scaleY,offsetX:tile.offsetX,offsetY:tile.offsetY,quality:opts.quality,alpha:opts.alpha,unsharpAmount:opts.unsharpAmount,unsharpRadius:opts.unsharpRadius,unsharpThreshold:opts.unsharpThreshold};_this2.debug('Invoke resize math');return Promise.resolve().then(function(){return invokeResize(o);}).then(function(result){if(canceled)return cancelToken;srcImageData=null;var toImageData;_this2.debug('Convert raw rgba tile result to ImageData');if(CAN_NEW_IMAGE_DATA){toImageData=new ImageData(new Uint8ClampedArray(result),tile.toWidth,tile.toHeight);}else{toImageData=toCtx.createImageData(tile.toWidth,tile.toHeight);if(toImageData.data.set){toImageData.data.set(result);}else{for(var i=toImageData.data.length-1;i>=0;i--){toImageData.data[i]=result[i];}}}
_this2.debug('Draw tile');if(NEED_SAFARI_FIX){toCtx.putImageData(toImageData,tile.toX,tile.toY,tile.toInnerX-tile.toX,tile.toInnerY-tile.toY,tile.toInnerWidth+1e-5,tile.toInnerHeight+1e-5);}else{toCtx.putImageData(toImageData,tile.toX,tile.toY,tile.toInnerX-tile.toX,tile.toInnerY-tile.toY,tile.toInnerWidth,tile.toInnerHeight);}
return null;});});};return Promise.resolve().then(function(){toCtx=to.getContext('2d',{alpha:Boolean(opts.alpha)});if(utils.isCanvas(from)){srcCtx=from.getContext('2d',{alpha:Boolean(opts.alpha)});return null;}
if(utils.isImageBitmap(from)){srcImageBitmap=from;isImageBitmapReused=true;return null;}
if(utils.isImage(from)){if(!CAN_CREATE_IMAGE_BITMAP)return null;_this2.debug('Decode image via createImageBitmap');return createImageBitmap(from).then(function(imageBitmap){srcImageBitmap=imageBitmap;})
["catch"](function(e){return null;});}
throw new Error('Pica: ".from" should be Image, Canvas or ImageBitmap');}).then(function(){if(canceled)return cancelToken;_this2.debug('Calculate tiles');var regions=createRegions({width:opts.width,height:opts.height,srcTileSize:_this2.options.tile,toWidth:opts.toWidth,toHeight:opts.toHeight,destTileBorder:destTileBorder});var jobs=regions.map(function(tile){return processTile(tile);});function cleanup(){if(srcImageBitmap){if(!isImageBitmapReused)srcImageBitmap.close();srcImageBitmap=null;}}
_this2.debug('Process tiles');return Promise.all(jobs).then(function(){_this2.debug('Finished!');cleanup();return to;},function(err){cleanup();throw err;});});};var processStages=function processStages(stages,from,to,opts){if(canceled)return cancelToken;var _stages$shift=stages.shift(),_stages$shift2=_slicedToArray(_stages$shift,2),toWidth=_stages$shift2[0],toHeight=_stages$shift2[1];var isLastStage=stages.length===0;opts=assign({},opts,{toWidth:toWidth,toHeight:toHeight,quality:isLastStage?opts.quality:Math.min(1,opts.quality)});var tmpCanvas;if(!isLastStage){tmpCanvas=_this2.options.createCanvas(toWidth,toHeight);}
return tileAndResize(from,isLastStage?to:tmpCanvas,opts).then(function(){if(isLastStage)return to;opts.width=toWidth;opts.height=toHeight;return processStages(stages,tmpCanvas,to,opts);}).then(function(res){if(tmpCanvas){tmpCanvas.width=tmpCanvas.height=0;}
return res;});};var stages=createStages(opts.width,opts.height,opts.toWidth,opts.toHeight,_this2.options.tile,destTileBorder);return processStages(stages,from,to,opts);});};Pica.prototype.resizeBuffer=function(options){var _this3=this;var opts=assign({},DEFAULT_RESIZE_OPTS,options);return this.init().then(function(){return _this3.__mathlib.resizeAndUnsharp(opts);});};Pica.prototype.toBlob=function(canvas,mimeType,quality){mimeType=mimeType||'image/png';return new Promise(function(resolve){if(canvas.toBlob){canvas.toBlob(function(blob){return resolve(blob);},mimeType,quality);return;}
if(canvas.convertToBlob){resolve(canvas.convertToBlob({type:mimeType,quality:quality}));return;}
var asString=atob(canvas.toDataURL(mimeType,quality).split(',')[1]);var len=asString.length;var asBuffer=new Uint8Array(len);for(var i=0;i<len;i++){asBuffer[i]=asString.charCodeAt(i);}
resolve(new Blob([asBuffer],{type:mimeType}));});};Pica.prototype.debug=function(){};module.exports=Pica;},{"./lib/mathlib":1,"./lib/pool":9,"./lib/stepper":10,"./lib/tiler":11,"./lib/utils":12,"./lib/worker":13,"object-assign":24,"webworkify":25}]},{},[])("/index.js")});});var image_traverse=createCommonjsModule(function(module){function error(message,code){var err=new Error(message);err.code=code;return err;}
function to_hex(number){var n=number.toString(16).toUpperCase();for(var i=2-n.length;i>0;i--)n='0'+n;return '0x'+n;}
function utf8_encode(str){try{return unescape(encodeURIComponent(str));}catch(_){return str;}}
function utf8_decode(str){try{return decodeURIComponent(escape(str));}catch(_){return str;}}
function is_uint8array(bin){return Object.prototype.toString.call(bin)==='[object Uint8Array]';}
function ExifParser(jpeg_bin,exif_start,exif_end){this.input=jpeg_bin.subarray(exif_start,exif_end);this.start=exif_start;var sig=String.fromCharCode.apply(null,this.input.subarray(0,4));if(sig!=='II\x2A\0'&&sig!=='MM\0\x2A'){throw error('invalid TIFF signature','EBADDATA');}
this.big_endian=sig[0]==='M';}
ExifParser.prototype.each=function(on_entry){this.aborted=false;var offset=this.read_uint32(4);this.ifds_to_read=[{id:0,offset:offset}];while(this.ifds_to_read.length>0&&!this.aborted){var i=this.ifds_to_read.shift();if(!i.offset)continue;this.scan_ifd(i.id,i.offset,on_entry);}};ExifParser.prototype.filter=function(on_entry){var ifds={};ifds.ifd0={id:0,entries:[]};this.each(function(entry){if(on_entry(entry)===false&&!entry.is_subifd_link)return;if(entry.is_subifd_link&&entry.count!==1&&entry.format!==4)return;if(!ifds['ifd'+entry.ifd]){ifds['ifd'+entry.ifd]={id:entry.ifd,entries:[]};}
ifds['ifd'+entry.ifd].entries.push(entry);});delete ifds.ifd1;var length=8;Object.keys(ifds).forEach(function(ifd_no){length+=2;ifds[ifd_no].entries.forEach(function(entry){length+=12+(entry.data_length>4?Math.ceil(entry.data_length/2)*2:0);});length+=4;});this.output=new Uint8Array(length);this.output[0]=this.output[1]=(this.big_endian?'M':'I').charCodeAt(0);this.write_uint16(2,0x2A);var offset=8;var self=this;this.write_uint32(4,offset);Object.keys(ifds).forEach(function(ifd_no){ifds[ifd_no].written_offset=offset;var ifd_start=offset;var ifd_end=ifd_start+2+ifds[ifd_no].entries.length*12+4;offset=ifd_end;self.write_uint16(ifd_start,ifds[ifd_no].entries.length);ifds[ifd_no].entries.sort(function(a,b){return a.tag-b.tag;}).forEach(function(entry,idx){var entry_offset=ifd_start+2+idx*12;self.write_uint16(entry_offset,entry.tag);self.write_uint16(entry_offset+2,entry.format);self.write_uint32(entry_offset+4,entry.count);if(entry.is_subifd_link){if(ifds['ifd'+entry.tag])ifds['ifd'+entry.tag].link_offset=entry_offset+8;}else if(entry.data_length<=4){self.output.set(self.input.subarray(entry.data_offset-self.start,entry.data_offset-self.start+4),entry_offset+8);}else{self.write_uint32(entry_offset+8,offset);self.output.set(self.input.subarray(entry.data_offset-self.start,entry.data_offset-self.start+entry.data_length),offset);offset+=Math.ceil(entry.data_length/2)*2;}});var next_ifd=ifds['ifd'+(ifds[ifd_no].id+1)];if(next_ifd)next_ifd.link_offset=ifd_end-4;});Object.keys(ifds).forEach(function(ifd_no){if(ifds[ifd_no].written_offset&&ifds[ifd_no].link_offset){self.write_uint32(ifds[ifd_no].link_offset,ifds[ifd_no].written_offset);}});if(this.output.length!==offset)throw error('internal error: incorrect buffer size allocated');return this.output;};ExifParser.prototype.read_uint16=function(offset){var d=this.input;if(offset+2>d.length)throw error('unexpected EOF','EBADDATA');return this.big_endian?d[offset]*0x100+d[offset+1]:d[offset]+d[offset+1]*0x100;};ExifParser.prototype.read_uint32=function(offset){var d=this.input;if(offset+4>d.length)throw error('unexpected EOF','EBADDATA');return this.big_endian?d[offset]*0x1000000+d[offset+1]*0x10000+d[offset+2]*0x100+d[offset+3]:d[offset]+d[offset+1]*0x100+d[offset+2]*0x10000+d[offset+3]*0x1000000;};ExifParser.prototype.write_uint16=function(offset,value){var d=this.output;if(this.big_endian){d[offset]=(value>>>8)&0xFF;d[offset+1]=value&0xFF;}else{d[offset]=value&0xFF;d[offset+1]=(value>>>8)&0xFF;}};ExifParser.prototype.write_uint32=function(offset,value){var d=this.output;if(this.big_endian){d[offset]=(value>>>24)&0xFF;d[offset+1]=(value>>>16)&0xFF;d[offset+2]=(value>>>8)&0xFF;d[offset+3]=value&0xFF;}else{d[offset]=value&0xFF;d[offset+1]=(value>>>8)&0xFF;d[offset+2]=(value>>>16)&0xFF;d[offset+3]=(value>>>24)&0xFF;}};ExifParser.prototype.is_subifd_link=function(ifd,tag){return(ifd===0&&tag===0x8769)||(ifd===0&&tag===0x8825)||(ifd===0x8769&&tag===0xA005);};ExifParser.prototype.exif_format_length=function(format){switch(format){case 1:case 2:case 6:case 7:return 1;case 3:case 8:return 2;case 4:case 9:case 11:return 4;case 5:case 10:case 12:return 8;default:return 0;}};ExifParser.prototype.exif_format_read=function(format,offset){var v;switch(format){case 1:case 2:v=this.input[offset];return v;case 6:v=this.input[offset];return v|(v&0x80)*0x1fffffe;case 3:v=this.read_uint16(offset);return v;case 8:v=this.read_uint16(offset);return v|(v&0x8000)*0x1fffe;case 4:v=this.read_uint32(offset);return v;case 9:v=this.read_uint32(offset);return v|0;case 5:case 10:case 11:case 12:return null;case 7:return null;default:return null;}};ExifParser.prototype.scan_ifd=function(ifd_no,offset,on_entry){var entry_count=this.read_uint16(offset);offset+=2;for(var i=0;i<entry_count;i++){var tag=this.read_uint16(offset);var format=this.read_uint16(offset+2);var count=this.read_uint32(offset+4);var comp_length=this.exif_format_length(format);var data_length=count*comp_length;var data_offset=data_length<=4?offset+8:this.read_uint32(offset+8);var is_subifd_link=false;if(data_offset+data_length>this.input.length){throw error('unexpected EOF','EBADDATA');}
var value=[];var comp_offset=data_offset;for(var j=0;j<count;j++,comp_offset+=comp_length){var item=this.exif_format_read(format,comp_offset);if(item===null){value=null;break;}
value.push(item);}
if(Array.isArray(value)&&format===2){try{value=utf8_decode(String.fromCharCode.apply(null,value));}catch(_){value=null;}
if(value&&value[value.length-1]==='\0')value=value.slice(0,-1);}
if(this.is_subifd_link(ifd_no,tag)){if(Array.isArray(value)&&Number.isInteger(value[0])&&value[0]>0){this.ifds_to_read.push({id:tag,offset:value[0]});is_subifd_link=true;}}
var entry={is_big_endian:this.big_endian,ifd:ifd_no,tag:tag,format:format,count:count,entry_offset:offset+this.start,data_length:data_length,data_offset:data_offset+this.start,value:value,is_subifd_link:is_subifd_link};if(on_entry(entry)===false){this.aborted=true;return;}
offset+=12;}
if(ifd_no===0){this.ifds_to_read.push({id:1,offset:this.read_uint32(offset)});}};module.exports.is_jpeg=function(jpeg_bin){return jpeg_bin.length>=4&&jpeg_bin[0]===0xFF&&jpeg_bin[1]===0xD8&&jpeg_bin[2]===0xFF;};module.exports.jpeg_segments_each=function(jpeg_bin,on_segment){if(!is_uint8array(jpeg_bin)){throw error('Invalid argument (jpeg_bin), Uint8Array expected','EINVAL');}
if(typeof on_segment!=='function'){throw error('Invalid argument (on_segment), Function expected','EINVAL');}
if(!module.exports.is_jpeg(jpeg_bin)){throw error('Unknown file format','ENOTJPEG');}
var offset=0,length=jpeg_bin.length,inside_scan=false;for(;;){var segment_code,segment_length;if(offset+1>=length)throw error('Unexpected EOF','EBADDATA');var byte1=jpeg_bin[offset];var byte2=jpeg_bin[offset+1];if(byte1===0xFF&&byte2===0xFF){segment_code=0xFF;segment_length=1;}else if(byte1===0xFF&&byte2!==0){segment_code=byte2;segment_length=2;if((0xD0<=segment_code&&segment_code<=0xD9)||segment_code===0x01);else{if(offset+3>=length)throw error('Unexpected EOF','EBADDATA');segment_length+=jpeg_bin[offset+2]*0x100+jpeg_bin[offset+3];if(segment_length<2)throw error('Invalid segment length','EBADDATA');if(offset+segment_length-1>=length)throw error('Unexpected EOF','EBADDATA');}
if(inside_scan){if(segment_code>=0xD0&&segment_code<=0xD7);else{inside_scan=false;}}
if(segment_code===0xDA)inside_scan=true;}else if(inside_scan){for(var pos=offset+1;;pos++){if(pos>=length)throw error('Unexpected EOF','EBADDATA');if(jpeg_bin[pos]===0xFF){if(pos+1>=length)throw error('Unexpected EOF','EBADDATA');if(jpeg_bin[pos+1]!==0){segment_code=0;segment_length=pos-offset;break;}}}}else{throw error('Unexpected byte at segment start: '+to_hex(byte1)+
' (offset '+to_hex(offset)+')','EBADDATA');}
if(on_segment({code:segment_code,offset:offset,length:segment_length})===false)break;if(segment_code===0xD9)break;offset+=segment_length;}};module.exports.jpeg_segments_filter=function(jpeg_bin,on_segment){if(!is_uint8array(jpeg_bin)){throw error('Invalid argument (jpeg_bin), Uint8Array expected','EINVAL');}
if(typeof on_segment!=='function'){throw error('Invalid argument (on_segment), Function expected','EINVAL');}
var ranges=[];var out_length=0;module.exports.jpeg_segments_each(jpeg_bin,function(segment){var new_segment=on_segment(segment);if(is_uint8array(new_segment)){ranges.push({data:new_segment});out_length+=new_segment.length;}else if(Array.isArray(new_segment)){new_segment.filter(is_uint8array).forEach(function(s){ranges.push({data:s});out_length+=s.length;});}else if(new_segment!==false){var new_range={start:segment.offset,end:segment.offset+segment.length};if(ranges.length>0&&ranges[ranges.length-1].end===new_range.start){ranges[ranges.length-1].end=new_range.end;}else{ranges.push(new_range);}
out_length+=segment.length;}});var result=new Uint8Array(out_length);var offset=0;ranges.forEach(function(range){var data=range.data||jpeg_bin.subarray(range.start,range.end);result.set(data,offset);offset+=data.length;});return result;};module.exports.jpeg_exif_tags_each=function(jpeg_bin,on_exif_entry){if(!is_uint8array(jpeg_bin)){throw error('Invalid argument (jpeg_bin), Uint8Array expected','EINVAL');}
if(typeof on_exif_entry!=='function'){throw error('Invalid argument (on_exif_entry), Function expected','EINVAL');}
module.exports.jpeg_segments_each(jpeg_bin,function(segment){if(segment.code===0xDA)return false;if(segment.code===0xE1&&segment.length>=10&&jpeg_bin[segment.offset+4]===0x45&&jpeg_bin[segment.offset+5]===0x78&&jpeg_bin[segment.offset+6]===0x69&&jpeg_bin[segment.offset+7]===0x66&&jpeg_bin[segment.offset+8]===0x00&&jpeg_bin[segment.offset+9]===0x00){new ExifParser(jpeg_bin,segment.offset+10,segment.offset+segment.length).each(on_exif_entry);return false;}});};module.exports.jpeg_exif_tags_filter=function(jpeg_bin,on_exif_entry){if(!is_uint8array(jpeg_bin)){throw error('Invalid argument (jpeg_bin), Uint8Array expected','EINVAL');}
if(typeof on_exif_entry!=='function'){throw error('Invalid argument (on_exif_entry), Function expected','EINVAL');}
var stop_search=false;return module.exports.jpeg_segments_filter(jpeg_bin,function(segment){if(stop_search)return;if(segment.code===0xDA)stop_search=true;if(segment.code===0xE1&&segment.length>=10&&jpeg_bin[segment.offset+4]===0x45&&jpeg_bin[segment.offset+5]===0x78&&jpeg_bin[segment.offset+6]===0x69&&jpeg_bin[segment.offset+7]===0x66&&jpeg_bin[segment.offset+8]===0x00&&jpeg_bin[segment.offset+9]===0x00){var new_exif=new ExifParser(jpeg_bin,segment.offset+10,segment.offset+segment.length).filter(on_exif_entry);if(!new_exif)return false;var header=new Uint8Array(10);header.set(jpeg_bin.slice(segment.offset,segment.offset+10));header[2]=((new_exif.length+8)>>>8)&0xFF;header[3]=(new_exif.length+8)&0xFF;stop_search=true;return[header,new_exif];}});};module.exports.jpeg_add_comment=function(jpeg_bin,comment){var comment_inserted=false,segment_count=0;return module.exports.jpeg_segments_filter(jpeg_bin,function(segment){segment_count++;if(segment_count===1&&segment.code===0xD8)return;if(segment_count===2&&segment.code===0xE0)return;if(comment_inserted)return;comment=utf8_encode(comment);var csegment=new Uint8Array(5+comment.length);var offset=0;csegment[offset++]=0xFF;csegment[offset++]=0xFE;csegment[offset++]=((comment.length+3)>>>8)&0xFF;csegment[offset++]=(comment.length+3)&0xFF;comment.split('').forEach(function(c){csegment[offset++]=c.charCodeAt(0)&0xFF;});csegment[offset++]=0;comment_inserted=true;return[csegment,jpeg_bin.subarray(segment.offset,segment.offset+segment.length)];});};});function jpeg_patch_exif(env){return this._getUint8Array(env.blob).then(function(data){env.is_jpeg=image_traverse.is_jpeg(data);if(!env.is_jpeg)return Promise.resolve(env);env.orig_blob=env.blob;try{var exif_is_big_endian,orientation_offset;image_traverse.jpeg_exif_tags_each(data,function(entry){if(entry.ifd===0&&entry.tag===0x112&&Array.isArray(entry.value)){env.orientation=entry.value[0]||1;exif_is_big_endian=entry.big_endian;orientation_offset=entry.data_offset;return false;}});if(orientation_offset){var orientation_patch=exif_is_big_endian?new Uint8Array([0,1]):new Uint8Array([1,0]);env.blob=new Blob([data.slice(0,orientation_offset),orientation_patch,data.slice(orientation_offset+2)],{type:'image/jpeg'});}}catch(_){}
return env;});}
function jpeg_rotate_canvas(env){if(!env.is_jpeg)return Promise.resolve(env);var orientation=env.orientation-1;if(!orientation)return Promise.resolve(env);var canvas;if(orientation&4){canvas=this.pica.options.createCanvas(env.out_canvas.height,env.out_canvas.width);}else{canvas=this.pica.options.createCanvas(env.out_canvas.width,env.out_canvas.height);}
var ctx=canvas.getContext('2d');ctx.save();if(orientation&1)ctx.transform(-1,0,0,1,canvas.width,0);if(orientation&2)ctx.transform(-1,0,0,-1,canvas.width,canvas.height);if(orientation&4)ctx.transform(0,1,1,0,0,0);ctx.drawImage(env.out_canvas,0,0);ctx.restore();env.out_canvas.width=env.out_canvas.height=0;env.out_canvas=canvas;return Promise.resolve(env);}
function jpeg_attach_orig_segments(env){if(!env.is_jpeg)return Promise.resolve(env);return Promise.all([this._getUint8Array(env.blob),this._getUint8Array(env.out_blob)]).then(function(res){var data=res[0];var data_out=res[1];if(image_traverse.is_jpeg(data_out))return Promise.resolve(env);var segments=[];image_traverse.jpeg_segments_each(data,function(segment){if(segment.code===0xDA)return false;segments.push(segment);});segments=segments.filter(function(segment){if(segment.code===0xE2){var hdr=data.slice(segment.offset+4,segment.offset+11);if(String.fromCharCode.apply(hdr)==='ICC_PROFILE'){return false;}}
if(segment.code>=0xE0&&segment.code<0xF0)return true;if(segment.code===0xFE)return true;return false;}).map(function(segment){return data.slice(segment.offset,segment.offset+segment.length);});env.blob=new Blob([data.slice(0,20)].concat(segments).concat([data.slice(20)]),{type:'image/jpeg'});return env;});}
function assign$1(reducer){reducer.before('_blob_to_image',jpeg_patch_exif);reducer.after('_transform',jpeg_rotate_canvas);reducer.after('_create_blob',jpeg_attach_orig_segments);}
var jpeg_patch_exif_1=jpeg_patch_exif;var jpeg_rotate_canvas_1=jpeg_rotate_canvas;var jpeg_attach_orig_segments_1=jpeg_attach_orig_segments;var assign_1=assign$1;var jpeg_plugins={jpeg_patch_exif:jpeg_patch_exif_1,jpeg_rotate_canvas:jpeg_rotate_canvas_1,jpeg_attach_orig_segments:jpeg_attach_orig_segments_1,assign:assign_1};function ImageBlobReduce(options){if(!(this instanceof ImageBlobReduce))return new ImageBlobReduce(options);options=options||{};this.pica=options.pica||pica();this.initialized=false;this.utils=utils;}
ImageBlobReduce.prototype.use=function(plugin){var args=[this].concat(Array.prototype.slice.call(arguments,1));plugin.apply(plugin,args);return this;};ImageBlobReduce.prototype.init=function(){this.use(jpeg_plugins.assign);};ImageBlobReduce.prototype.toBlob=function(blob,options){var opts=utils.assign({max:Infinity},options);var env={blob:blob,opts:opts};if(!this.initialized){this.init();this.initialized=true;}
return Promise.resolve(env).then(this._blob_to_image).then(this._calculate_size).then(this._transform).then(this._cleanup).then(this._create_blob).then(function(_env){_env.out_canvas.width=_env.out_canvas.height=0;return _env.out_blob;});};ImageBlobReduce.prototype.toCanvas=function(blob,options){var opts=utils.assign({max:Infinity},options);var env={blob:blob,opts:opts};if(!this.initialized){this.init();this.initialized=true;}
return Promise.resolve(env).then(this._blob_to_image).then(this._calculate_size).then(this._transform).then(this._cleanup).then(function(_env){return _env.out_canvas;});};ImageBlobReduce.prototype.before=function(method_name,fn){if(!this[method_name])throw new Error('Method "'+method_name+'" does not exist');if(typeof fn!=='function')throw new Error('Invalid argument "fn", function expected');var old_fn=this[method_name];var self=this;this[method_name]=function(env){return fn.call(self,env).then(function(_env){return old_fn.call(self,_env);});};return this;};ImageBlobReduce.prototype.after=function(method_name,fn){if(!this[method_name])throw new Error('Method "'+method_name+'" does not exist');if(typeof fn!=='function')throw new Error('Invalid argument "fn", function expected');var old_fn=this[method_name];var self=this;this[method_name]=function(env){return old_fn.call(self,env).then(function(_env){return fn.call(self,_env);});};return this;};ImageBlobReduce.prototype._blob_to_image=function(env){var URL=window.URL||window.webkitURL||window.mozURL||window.msURL;env.image=document.createElement('img');env.image_url=URL.createObjectURL(env.blob);env.image.src=env.image_url;return new Promise(function(resolve,reject){env.image.onerror=function(){reject(new Error('ImageBlobReduce: failed to create Image() from blob'));};env.image.onload=function(){resolve(env);};});};ImageBlobReduce.prototype._calculate_size=function(env){var scale_factor=env.opts.max/Math.max(env.image.width,env.image.height);if(scale_factor>1)scale_factor=1;env.transform_width=Math.max(Math.round(env.image.width*scale_factor),1);env.transform_height=Math.max(Math.round(env.image.height*scale_factor),1);env.scale_factor=scale_factor;return Promise.resolve(env);};ImageBlobReduce.prototype._transform=function(env){env.out_canvas=this.pica.options.createCanvas(env.transform_width,env.transform_height);env.transform_width=null;env.transform_height=null;var pica_opts={alpha:env.blob.type==='image/png'};this.utils.assign(pica_opts,this.utils.pick_pica_resize_options(env.opts));return this.pica.resize(env.image,env.out_canvas,pica_opts).then(function(){return env;});};ImageBlobReduce.prototype._cleanup=function(env){env.image.src='';env.image=null;var URL=window.URL||window.webkitURL||window.mozURL||window.msURL;if(URL.revokeObjectURL)URL.revokeObjectURL(env.image_url);env.image_url=null;return Promise.resolve(env);};ImageBlobReduce.prototype._create_blob=function(env){return this.pica.toBlob(env.out_canvas,env.blob.type).then(function(blob){env.out_blob=blob;return env;});};ImageBlobReduce.prototype._getUint8Array=function(blob){if(blob.arrayBuffer){return blob.arrayBuffer().then(function(buf){return new Uint8Array(buf);});}
return new Promise(function(resolve,reject){var fr=new FileReader();fr.readAsArrayBuffer(blob);fr.onload=function(){resolve(new Uint8Array(fr.result));};fr.onerror=function(){reject(new Error('ImageBlobReduce: failed to load data from input blob'));fr.abort();};fr.onabort=function(){reject(new Error('ImageBlobReduce: failed to load data from input blob (aborted)'));};});};ImageBlobReduce.pica=pica;var imageBlobReduce=ImageBlobReduce;return imageBlobReduce;})));